****************************************************
* 01_data_build.do â€” Pool HBSC 2006, 2010, 2014
* Keep ALL variables, filter to Belgium (Flemish)
* Outputs:
*   data/interim/hbsc2006_BEFL_clean.dta
*   data/interim/hbsc2010_BEFL_clean.dta
*   data/interim/hbsc2014_BEFL_clean.dta
*   data/final/hbsc_pooled_BEFL_full.dta
*   output/logs/build.log
****************************************************

clear all
set more off
set varabbrev off

*---------------------------------------------------
* Project paths  (update PROJ if your local path differs)
*---------------------------------------------------
global PROJ "/Users/aarushbathula/Developer/ec338-hbsc-belgium-flemish"
cd "$PROJ"

global RAW   "$PROJ/data/raw"
global INT   "$PROJ/data/interim"
global FINAL "$PROJ/data/final"
global LOGS  "$PROJ/output/logs"

capture mkdir "$INT"
capture mkdir "$FINAL"
capture mkdir "$LOGS"

capture log close
log using "$LOGS/build.log", replace text

*---------------------------------------------------
* Parameters
*---------------------------------------------------
local COUNTRY_CODE = 56001                  // Belgium (Flemish)
local f2006 "HBSC2006OAed1.0_F1.dta"
local f2010 "HBSC2010OAed1.0_F4.dta"
local f2014 "HBSC2014OAed1.1_F1.dta"

*---------------------------------------------------
* Pre-flight: confirm raw files exist
*---------------------------------------------------
foreach f in `f2006' `f2010' `f2014' {
    capture confirm file "$RAW/`f'"
    if _rc {
        di as error "âŒ Missing raw file: $RAW/`f'"
        log close
        exit 601
    }
}
di as result "âœ… All raw files present."

*---------------------------------------------------
* Housekeeping: remove stale outputs from previous runs
* (does NOT touch data/raw)
*---------------------------------------------------
capture noisily {
    cap erase "$INT/hbsc2006_BEFL_clean.dta"
    cap erase "$INT/hbsc2010_BEFL_clean.dta"
    cap erase "$INT/hbsc2014_BEFL_clean.dta"
    cap erase "$FINAL/hbsc_pooled_BEFL_full.dta"
}

****************************************************
* 2006 wave  -> data/interim/hbsc2006_BEFL_clean.dta
****************************************************
use "$RAW/`f2006'", clear
gen wave = 2006
capture rename countryno country
capture rename schoolno  school
capture rename classno   class
capture rename uniqueid  pid
capture rename sampleweights weight
capture rename subregion stratum
keep if country == `COUNTRY_CODE'
save "$INT/hbsc2006_BEFL_clean.dta", replace
di as txt "2006 saved (" _N " obs)"

****************************************************
* 2010 wave  -> data/interim/hbsc2010_BEFL_clean.dta
****************************************************
use "$RAW/`f2010'", clear
gen wave = 2010
capture rename countryno country
capture rename schoolno  school
capture rename classno   class
capture rename uniqueid  pid
capture rename sampleweights weight
capture rename subregion stratum
keep if country == `COUNTRY_CODE'
save "$INT/hbsc2010_BEFL_clean.dta", replace
di as txt "2010 saved (" _N " obs)"

****************************************************
* 2014 wave  -> data/interim/hbsc2014_BEFL_clean.dta
****************************************************
use "$RAW/`f2014'", clear
gen wave = 2014
capture rename COUNTRYno country
capture rename id2       school
capture rename id3       class
capture rename UniqueID  pid
capture rename M137      weight
capture rename REG_NO    stratum
keep if country == `COUNTRY_CODE'
save "$INT/hbsc2014_BEFL_clean.dta", replace
di as txt "2014 saved (" _N " obs)"

****************************************************
* Append interim files and save final pooled dataset
****************************************************
use "$INT/hbsc2006_BEFL_clean.dta", clear
append using "$INT/hbsc2010_BEFL_clean.dta"
append using "$INT/hbsc2014_BEFL_clean.dta"

levelsof wave, local(W)
assert "`W'" == "2006 2010 2014"

save "$FINAL/hbsc_pooled_BEFL_full.dta", replace
di as result "ðŸŽ‰ Saved: $FINAL/hbsc_pooled_BEFL_full.dta (" _N " obs)"

log close